# Fleet Management Integration

**Coordinate multiple Igris Runtime instances with Igris Overture for distributed AI inference.**

Fleet Management enables your edge runtime instances to sync with a central Overture control plane, providing:
- **Distributed telemetry** - Real-time metrics from all edge nodes
- **Configuration sync** - Push config updates to entire fleet
- **Health monitoring** - Track instance status across regions
- **Load balancing** - Automatic routing to healthy instances

---

## Quick Start

### 1. Enable Fleet Management

```toml
# config.json5
{
  "fleet": {
    "enabled": true,
    "overture_url": "https://api.igrisinertial.com",
    "agent_id": "runtime-us-east-1a",
    "sync_interval_secs": 30,
    "telemetry_enabled": true
  }
}
```

### 2. Register with Overture

```bash
# Set Overture API key
export IGRIS_OVERTURE_API_KEY="your-api-key"

# Start runtime with fleet enabled
./igris-runtime --config config.json5
```

### 3. Verify Connection

```bash
# Check fleet status
curl http://localhost:8081/v1/fleet/status

# Response:
{
  "agent_id": "runtime-us-east-1a",
  "status": "connected",
  "overture_url": "https://api.igrisinertial.com",
  "last_sync": "2025-12-28T10:30:00Z",
  "telemetry_uploads": 142,
  "config_version": "v1.6.0"
}
```

---

## Architecture

### Hybrid Mode (Default)

Fleet management operates in **hybrid mode** by default:

```
┌─────────────────────────────────────────────┐
│  Igris Runtime (Edge Instance)              │
│  ┌────────────────────────────────────┐     │
│  │ FleetAgent                         │     │
│  │  - Telemetry Upload (30s)          │────┐│
│  │  - Config Sync (60s)               │    ││
│  │  - Health Heartbeat (10s)          │    ││
│  └────────────────────────────────────┘    ││
│                                             ││
│  ┌────────────────────────────────────┐    ││
│  │ LocalLLMProvider                   │    ││
│  │  - Works offline if sync fails     │    ││
│  │  - Cached config (72-hour TTL)     │    ││
│  └────────────────────────────────────┘    ││
└─────────────────────────────────────────────┘│
                                               │
                      Network                  │
                        │                      │
                        ▼                      │
┌──────────────────────────────────────────────┘
│  Igris Overture (Control Plane)
│  ┌────────────────────────────────────┐
│  │ Fleet API                          │
│  │  - /v1/fleet/instances             │
│  │  - /v1/fleet/metrics               │
│  │  - /v1/fleet/config                │
│  └────────────────────────────────────┘
│
│  ┌────────────────────────────────────┐
│  │ Dashboard                          │
│  │  - Real-time fleet view            │
│  │  - Instance health                 │
│  │  - Metrics aggregation             │
│  └────────────────────────────────────┘
└────────────────────────────────────────┘
```

### Graceful Degradation

If Overture becomes unavailable:

1. **Telemetry upload fails** → Queued locally (up to 1000 events)
2. **Config sync fails** → Uses cached config (72-hour TTL)
3. **After 72 hours** → Falls back to local-only mode
4. **When Overture returns** → Auto-reconnects and syncs queue

**Zero downtime** - Runtime continues serving requests offline.

---

## Configuration

### Fleet Agent Settings

```json5
{
  "fleet": {
    // Required
    "enabled": true,
    "overture_url": "https://api.igrisinertial.com",

    // Agent identification
    "agent_id": "runtime-us-east-1a",        // Unique ID for this instance
    "region": "us-east-1",                    // Geographic region
    "availability_zone": "a",                 // Availability zone

    // Sync intervals
    "sync_interval_secs": 30,                 // Config sync frequency
    "telemetry_interval_secs": 30,            // Metrics upload frequency
    "heartbeat_interval_secs": 10,            // Health check frequency

    // Telemetry options
    "telemetry_enabled": true,                // Enable metrics upload
    "telemetry_batch_size": 100,              // Events per upload
    "telemetry_queue_size": 1000,             // Max queued events

    // Security
    "tls_verify": true,                       // Verify Overture TLS cert
    "api_key_env": "IGRIS_OVERTURE_API_KEY",  // Env var for API key

    // Retry & timeout
    "connect_timeout_secs": 5,                // Connection timeout
    "request_timeout_secs": 10,               // Request timeout
    "max_retries": 3,                         // Retry attempts
    "retry_backoff_secs": 2                   // Backoff between retries
  }
}
```

### Environment Variables

```bash
# Required
export IGRIS_OVERTURE_API_KEY="your-api-key"

# Optional overrides
export IGRIS_FLEET_AGENT_ID="custom-id"
export IGRIS_FLEET_REGION="eu-west-1"
export IGRIS_FLEET_SYNC_INTERVAL="60"  # seconds
```

---

## Telemetry Data

### Metrics Uploaded

**System metrics** (every 30 seconds):
```json
{
  "agent_id": "runtime-us-east-1a",
  "timestamp": 1735387800,
  "metrics": {
    "cpu_usage_percent": 45.2,
    "memory_usage_mb": 2048,
    "disk_usage_mb": 15360,
    "active_requests": 12,
    "requests_per_sec": 150.5
  },
  "status": {
    "health": "healthy",
    "uptime_secs": 864000,
    "active_tasks": 3
  }
}
```

**Inference metrics** (per request):
```json
{
  "request_id": "req_abc123",
  "model": "phi-3-mini-4k-instruct",
  "provider": "local",
  "latency_ms": 245,
  "tokens": {"input": 150, "output": 50},
  "success": true,
  "timestamp": 1735387800
}
```

**Error events** (when errors occur):
```json
{
  "event_type": "error",
  "severity": "warning",
  "error_code": "MODEL_LOAD_FAILED",
  "message": "Failed to load model: Out of memory",
  "timestamp": 1735387800
}
```

### Privacy & Security

**What is uploaded:**
- ✅ Performance metrics (CPU, memory, latency)
- ✅ Request counts and success rates
- ✅ Error types and frequencies
- ✅ Model usage statistics

**What is NOT uploaded:**
- ❌ Prompt content
- ❌ LLM responses
- ❌ User data
- ❌ API keys

All telemetry is encrypted in transit (TLS 1.3) and optionally encrypted at rest.

---

## Fleet Dashboard

### Visualize Your Entire Fleet in Real-Time

Access the fleet dashboard at:
```
https://console.igrisinertial.com/dashboard/fleet
```

Monitor all your edge runtime instances from a single, unified dashboard. Get instant visibility into your distributed AI infrastructure across regions and availability zones.

**What You Can See:**
- **Instance Health** - Online, offline, or maintenance status at a glance
- **Performance Metrics** - CPU usage, memory consumption, and response times
- **Request Analytics** - Total requests processed and current throughput
- **Error Monitoring** - Fleet-wide error rates with automatic alerts
- **Regional Distribution** - Geographic spread of your instances
- **Capacity Planning** - Current usage vs. total available capacity

**Auto-Refresh**: Dashboard updates every 30 seconds automatically, ensuring you always see the latest state of your fleet.

### Why Use Fleet Dashboard?

**Operational Visibility**
Stop wondering if your edge instances are running. See everything in one place—status, performance, and health across all regions.

**Faster Troubleshooting**
Quickly identify which instances are experiencing issues. High error rates? Unusual latency? You'll know immediately which region needs attention.

**Proactive Monitoring**
Catch problems before users do. Built-in alerts notify you when error rates exceed thresholds or instances go offline.

**Capacity Planning**
Understand your fleet's actual usage vs. available capacity. Make informed decisions about scaling up or down based on real data.

**Cost Optimization**
Identify underutilized instances that could be downsized or over-stressed instances that need more resources.

---

## API Endpoints

### Local Runtime Endpoints

**Get fleet status:**
```bash
GET /v1/fleet/status

# Response:
{
  "agent_id": "runtime-us-east-1a",
  "status": "connected",
  "overture_url": "https://api.igrisinertial.com",
  "last_sync": "2025-12-28T10:30:00Z",
  "telemetry_uploads": 142,
  "config_version": "v1.6.0",
  "queue_size": 0
}
```

**Trigger manual sync:**
```bash
POST /v1/fleet/sync

# Response:
{
  "status": "success",
  "synced_at": "2025-12-28T10:30:15Z",
  "config_updated": true,
  "telemetry_uploaded": 25
}
```

**Disconnect from fleet:**
```bash
POST /v1/fleet/disconnect

# Response:
{
  "status": "disconnected",
  "message": "Fleet agent stopped. Runtime continues in local-only mode."
}
```

### Overture Control Plane Endpoints

**List all instances** (Overture API):
```bash
GET https://api.igrisinertial.com/v1/fleet/instances

# Response:
[
  {
    "agent_id": "runtime-us-east-1a",
    "region": "us-east-1",
    "status": "online",
    "last_heartbeat": "2025-12-28T10:30:00Z",
    "uptime_secs": 864000,
    "requests_processed": 1250000,
    "error_rate": 0.02
  },
  ...
]
```

**Get fleet metrics** (Overture API):
```bash
GET https://api.igrisinertial.com/v1/fleet/metrics

# Response:
{
  "total_instances": 12,
  "online_instances": 10,
  "offline_instances": 2,
  "total_requests_served": 15000000,
  "fleet_error_rate": 0.015,
  "avg_latency_ms": 185
}
```

---

## Use Cases

### 1. Multi-Region Deployment

Deploy runtime instances across multiple regions:

```bash
# US East
IGRIS_FLEET_AGENT_ID="runtime-us-east-1a" \
IGRIS_FLEET_REGION="us-east-1" \
./igris-runtime --config us-east.json5

# EU West
IGRIS_FLEET_AGENT_ID="runtime-eu-west-1a" \
IGRIS_FLEET_REGION="eu-west-1" \
./igris-runtime --config eu-west.json5

# Asia Pacific
IGRIS_FLEET_AGENT_ID="runtime-ap-southeast-1a" \
IGRIS_FLEET_REGION="ap-southeast-1" \
./igris-runtime --config ap-southeast.json5
```

Monitor all instances from single Overture dashboard.

### 2. Edge AI Fleet

Deploy to IoT/edge devices with centralized control:

```json5
// Raspberry Pi, NVIDIA Jetson, etc.
{
  "fleet": {
    "enabled": true,
    "overture_url": "https://api.igrisinertial.com",
    "agent_id": "edge-device-${DEVICE_ID}",
    "telemetry_interval_secs": 60,  // Longer interval for edge
    "telemetry_queue_size": 5000    // Larger queue for offline periods
  }
}
```

### 3. A/B Testing

Test new configurations on subset of fleet:

```bash
# Push config to 10% of instances
curl -X POST https://api.igrisinertial.com/v1/fleet/config \
  -H "Authorization: Bearer $API_KEY" \
  -d '{
    "target_instances": ["runtime-us-east-1a", "runtime-eu-west-1a"],
    "config": {
      "local_llm": {
        "n_gpu_layers": 35  # New GPU offload setting
      }
    }
  }'

# Monitor metrics, then roll out to all if successful
```

---

## Troubleshooting

### Fleet agent not connecting

**Check Overture URL:**
```bash
curl -v https://api.igrisinertial.com/v1/health
```

**Verify API key:**
```bash
echo $IGRIS_OVERTURE_API_KEY
# Should output your API key
```

**Check logs:**
```bash
# Look for fleet connection logs
grep "fleet" logs/igris-runtime.log

# Should see:
# [INFO] Fleet agent connected to https://api.igrisinertial.com
# [INFO] Telemetry upload successful (25 events)
```

### Telemetry not uploading

**Check queue size:**
```bash
curl http://localhost:8081/v1/fleet/status | jq .queue_size

# If queue_size > 0, telemetry is queued but not uploading
```

**Check network:**
```bash
# Test Overture connectivity
curl https://api.igrisinertial.com/v1/fleet/telemetry \
  -H "Authorization: Bearer $IGRIS_OVERTURE_API_KEY" \
  -d '{}'
```

**Increase timeout:**
```json5
{
  "fleet": {
    "request_timeout_secs": 30,  // Increased from 10
    "max_retries": 5             // Increased from 3
  }
}
```

### Instance shows as offline in dashboard

**Check heartbeat:**
```bash
# Heartbeat should happen every 10 seconds by default
grep "heartbeat" logs/igris-runtime.log
```

**Verify clock sync:**
```bash
# Ensure system clock is correct (important for heartbeat timestamps)
timedatectl status  # Linux
date               # macOS
```

**Manual heartbeat:**
```bash
# Force immediate heartbeat
curl -X POST http://localhost:8081/v1/fleet/heartbeat
```

---

## Security

### API Key Management

**Storage:**
- API keys stored in environment variables (not config files)
- Never logged or included in telemetry
- Rotated automatically every 90 days (if enabled in Overture)

**Permissions:**
- Fleet API keys have limited scope: `fleet:read fleet:write`
- Cannot access other tenant data
- Row-level security enforced in Overture database

### TLS Configuration

**Default:** TLS 1.3 with certificate verification

**Custom CA certificate:**
```json5
{
  "fleet": {
    "tls_verify": true,
    "tls_ca_cert": "/path/to/ca.crt"
  }
}
```

**Disable verification** (dev only):
```json5
{
  "fleet": {
    "tls_verify": false  // ⚠️ Only use in development
  }
}
```

### Data Encryption

**In transit:** TLS 1.3
**At rest:** AES-256-GCM (if enabled in Overture)
**Telemetry:** No sensitive data included (see Privacy section)

---

## Performance

### Network Overhead

**Telemetry upload** (every 30s):
- Payload size: ~2 KB per instance
- Bandwidth: ~0.5 KB/s continuous
- Impact: Negligible (less than 0.01% CPU)

**Config sync** (every 60s):
- Payload size: ~5 KB
- Bandwidth: ~0.08 KB/s continuous
- Impact: Negligible

**Total bandwidth:** Less than 1 KB/s per instance

### Latency Impact

Fleet management runs asynchronously:
- **Zero latency** added to inference requests
- Telemetry upload: Background thread
- Config sync: Background thread
- Heartbeat: Background thread

---

## Best Practices

1. **Use unique agent IDs** - Include region/AZ in ID for easy identification
2. **Set appropriate intervals** - 30s telemetry, 60s config sync works well
3. **Monitor queue size** - If queue > 500, investigate network issues
4. **Enable graceful degradation** - Always allow offline operation
5. **Rotate API keys** - Use 90-day rotation policy
6. **Test failover** - Verify runtime works when Overture is down
7. **Use health checks** - Monitor `/v1/fleet/status` endpoint

---

## Roadmap

### Q1 2026
- [ ] Full dashboard integration (replace mock data)
- [ ] Real-time fleet metrics in Overture UI
- [ ] Automated rollouts and rollbacks
- [ ] Fleet-wide config validation

### Q2 2026
- [ ] Multi-fleet support (dev/staging/prod)
- [ ] Advanced load balancing across instances
- [ ] Automatic scaling triggers
- [ ] Custom telemetry metrics

---

## Related Documentation

- [Configuration Reference](/docs/configuration) - Full config options
- [Observability](/docs/observability) - Metrics and monitoring
- [Security](/docs/security) - Security best practices
- [Dashboard Audit](/DASHBOARD_AUDIT_REPORT.md) - Current dashboard status

---

**Questions?** Open an issue at [github.com/igris-runtime/igris-runtime](https://github.com/igris-runtime/igris-runtime)
