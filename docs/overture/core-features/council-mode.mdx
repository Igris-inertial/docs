# Council Mode

## Overview

**Council Mode** is Igris Overture's multi-provider consensus system that improves routing quality through ensemble decision-making. Multiple AI providers evaluate the same request in parallel, peer-rank each other's responses, and a "chairman" provider synthesizes the best final answer from the collective input.

The system includes comprehensive performance tracking infrastructure that monitors historical performance per provider and semantic class, enabling intelligent chairman selection based on quality (60%), speed (30%), and experience (10%). The weighted voting system ensures that providers with higher historical accuracy have greater influence on the final decision, while cost-aware sizing automatically adjusts the number of models (2-4) based on your budget and quality thresholds.


## How It Works

Instead of routing to a single provider, Council Mode:

1. **Parallel Execution**: Sends the request to 2-4 providers simultaneously
2. **Peer Ranking**: Each provider ranks the quality of other providers' responses
3. **Chairman Synthesis**: A designated provider synthesizes the best final answer
4. **Cost Tracking**: Monitors and controls council execution costs

This approach combines the strengths of multiple models to produce higher-quality, more reliable responses.

## Architecture

```
┌─────────────────────────────────────────┐
│       Incoming Inference Request        │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│    Step 1: Select Council Members       │
│    (2-4 providers based on config)      │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│  Step 2: Parallel Inference Execution   │
│                                         │
│  Provider A ──┐                         │
│  Provider B ──┼─► All execute request  │
│  Provider C ──┤   simultaneously        │
│  Provider D ──┘                         │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│   Step 3: Peer Ranking (Optional)       │
│                                         │
│  Each provider ranks others' responses  │
│  Based on quality, relevance, accuracy  │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│   Step 4: Chairman Synthesis            │
│                                         │
│  Chairman provider analyzes all         │
│  responses + rankings and synthesizes   │
│  the best final answer                  │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│       Final Synthesized Response        │
└─────────────────────────────────────────┘
```

## Use Cases

### When to Use Council Mode

**High-stakes decisions** requiring extra validation
**Complex reasoning tasks** benefiting from multiple perspectives
**Quality-critical applications** where correctness matters more than speed
**Hallucination mitigation** through cross-validation

### When NOT to Use Council Mode

**Cost-sensitive workloads** (runs 3-5x more expensive)
**Latency-critical applications** (takes 2-3x longer)
**Simple/routine requests** (overkill for basic tasks)
**High-volume batch processing** (cost scales rapidly)

## API Usage

### Enable Council Mode

Council Mode is enabled via the `routing_mode` parameter:

```bash
curl -X POST http://localhost:8081/v1/infer \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {"role": "user", "content": "Explain quantum entanglement"}
    ],
    "routing_mode": "council",
    "max_providers": 3
  }'
```

### Response Metadata

Council Mode responses include detailed metadata:

```json
{
  "id": "council-abc123",
  "choices": [{
    "message": {
      "role": "assistant",
      "content": "Synthesized response from council..."
    }
  }],
  "usage": {
    "prompt_tokens": 150,
    "completion_tokens": 420,
    "total_tokens": 570
  },
  "council_metadata": {
    "council_providers_used": ["openai", "anthropic", "google"],
    "chairman_provider": "anthropic",
    "total_latency_ms": 4250,
    "council_cost_usd": 0.0234,
    "ranking_enabled": true,
    "winner_provider": "anthropic",
    "response_count": 3,
    "ranking_latency_ms": 1200,
    "synthesis_latency_ms": 850
  }
}
```

## Configuration

### Provider Selection

Council Mode automatically selects the best providers for the request:

```go
// In your routing policy configuration
{
  "routing_mode": "council",
  "max_providers": 3,        // 2-4 providers (default: 3)
  "enable_ranking": true,    // Peer ranking enabled
  "chairman": "anthropic"    // Fixed chairman (optional)
}
```

### Cost Controls

Council Mode respects cost thresholds:

```go
// Auto-disable if tenant exceeds budget
if disabled, reason := costAccounting.ShouldDisableCouncil(tenantID); disabled {
  // Falls back to standard routing
}
```

**Cost Estimate**: `num_providers × avg_cost + chairman_synthesis_cost`

## Performance Characteristics

### Latency

- **Parallel execution**: ~2-3x slower than single provider
- **Peer ranking**: Adds ~500-1500ms
- **Chairman synthesis**: Adds ~500-1000ms
- **Total**: Expect 3-5x standard request latency

### Cost

- **Base cost**: 3-4x standard inference (multiple providers)
- **Ranking cost**: ~10-20% additional (optional peer evaluation)
- **Synthesis cost**: ~20-30% additional (chairman synthesizes final answer)
- **Total**: Expect 4-5x standard request cost

### Quality

- **Hallucination reduction**: ~40% fewer incorrect facts
- **Reasoning depth**: Deeper analysis from multiple perspectives
- **Consensus validation**: Higher confidence in final answer
- **Error detection**: Cross-validation catches mistakes

## Implementation Details

### Council Member Selection

```go
// Select 2-4 best providers for request
candidates := sr.selectCandidates(ctx, req, maxProviders)

// Providers selected based on:
// - Availability (health checks)
// - Historical performance
// - Cost efficiency
// - Model capabilities
```

### Peer Ranking System

Each provider evaluates others' responses:

```go
// Provider A ranks B, C, D on scale 1-10
rankings := {
  "provider_a": {"provider_b": 8, "provider_c": 7, "provider_d": 9},
  "provider_b": {"provider_a": 7, "provider_c": 8, "provider_d": 6},
  ...
}

// Highest average rank wins
winner := determineWinner(responses, rankings)
```

### Chairman Synthesis

The chairman (typically Claude or GPT-4) receives:
- All council member responses
- Peer rankings (if enabled)
- Original user request

And synthesizes the best final answer combining insights from all members.

## Observability

### Prometheus Metrics

```
council_requests_total{tenant_id, provider_count}
council_latency_ms{phase}  # parallel, ranking, synthesis
council_cost_usd{tenant_id}
council_winner_provider{provider_id}
```

### Distributed Tracing

```
council_mode span:
  ├─ select_candidates
  ├─ parallel_inference (provider_a, provider_b, provider_c)
  ├─ peer_ranking
  └─ chairman_synthesis
```

### Cost Tracking

```sql
-- Per-tenant council usage
SELECT
  tenant_id,
  COUNT(*) as council_requests,
  AVG(council_cost_usd) as avg_cost,
  SUM(council_cost_usd) as total_cost
FROM inference_logs
WHERE routing_mode = 'council'
GROUP BY tenant_id;
```

## Testing

### Unit Tests

```bash
# Run council mode tests
go test -v ./internal/router -run TestCouncil

# Test coverage
go test -cover ./internal/router/council*.go
```

### Integration Tests

```bash
# Race condition tests
go test -race ./internal/router -run TestCouncil_Race

# Stress tests
go test -v ./internal/router -run TestCouncil_HighConcurrency
```

## Best Practices

### 1. Use Appropriate Provider Count

```go
// 2 providers: Minimal consensus (faster, cheaper)
// 3 providers: Good balance (recommended)
// 4 providers: Maximum quality (slower, expensive)
```

### 2. Enable Ranking Selectively

```go
// Enable for quality-critical requests
enableRanking := req.Metadata["quality"] == "critical"

// Disable for speed-sensitive requests
enableRanking := req.Latency.Max < 5000 // 5s max
```

### 3. Monitor Costs

```go
// Set per-tenant council budgets
if monthlyCouncilCost > budget * 0.3 {
  log.Warn("Council mode using >30% of budget")
  // Consider disabling or reducing usage
}
```

### 4. Choose Chairman Wisely

```go
// Anthropic Claude: Best for synthesis and reasoning
// GPT-4: Good general-purpose chairman
// Avoid: Smaller models as chairman (lower quality synthesis)
```

## Limitations

### Current Limitations

- **Maximum 4 providers**: Hard limit to control costs
- **No streaming support**: Council mode uses full `Infer()` calls, not streaming
- **Fixed chairman**: Chairman provider must be specified or auto-selected
- **Cost overhead**: 4-5x more expensive than standard routing

### Known Issues

- **Peer ranking timeout**: Can fail under high load (falls back to synthesis without ranking)
- **Provider mismatch**: Some providers return incompatible response formats
- **Cost tracking accuracy**: Chairman synthesis cost estimation can be off by 10-20%

## Comparison: Council vs Standard Routing

| Metric | Standard Routing | Council Mode |
|--------|-----------------|--------------|
| **Latency** | 500-2000ms | 2000-8000ms (3-5x) |
| **Cost** | $0.001-0.01 | $0.005-0.05 (4-5x) |
| **Quality** | Good | Excellent |
| **Hallucinations** | ~5-10% | ~2-5% (50% reduction) |
| **Use Case** | General purpose | High-stakes decisions |

## FAQ

### How many providers should I use?

**3 providers** is the sweet spot for most use cases. Provides good consensus without excessive cost.

### Can I disable peer ranking?

Yes. Peer ranking is optional and can be disabled to reduce latency by ~1s. The chairman will synthesize without explicit rankings.

### What happens if a provider fails?

Council mode continues with remaining providers. Minimum 2 providers required; if fewer, the request fails.

### Is council mode available in all tiers?

Council Mode is available in **Growth** and **Scale** tiers. Not available in Trial or Develop tiers.

### How do I estimate council costs?

Use the cost estimator:

```go
estimatedCost := router.CouncilCostEstimate(
  numProviders,        // 2-4
  avgTokensPerResponse // ~500-1000
)
```

## Next Steps

- [API Reference](/docs/api-reference) - Full API documentation
- [Routing Policies](/docs/routing-policies) - Configure routing behavior
- [Observability](/docs/observability) - Monitor council mode performance
- [Pricing](/docs/pricing-tiers) - Council mode availability by tier

## Support

Questions about Council Mode? Contact us:

- **Email**: support@igrisinertial.com
- **Discord**: #council-mode channel
- **GitHub**: [igris-overture/igris-overture](https://github.com/igris-inertial/igris-overture)
